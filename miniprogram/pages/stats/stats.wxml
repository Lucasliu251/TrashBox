<view class="container">
  <block wx:if="{{ !isLogged }}">
    <view class="empty-state">
      <image class="empty-icon" src="/assets/icons/cs-logo-grey.avif" mode="widthFix"></image>
      <text class="empty-text">ç»‘å®š Steam è´¦å·å¼€å¯æ•°æ®åˆ†æ</text>
      <text class="empty-subtext">æŸ¥çœ‹æ‚¨çš„ Ratingã€ADR åŠæ¯”èµ›èµ°åŠ¿</text>
      <button class="btn-primary" bindtap="goToOnboarding">è¿æ¥ Steam è´¦æˆ·</button>
    </view>
  </block>
  <block wx:else>
    <scroll-view scroll-y class="dashboard">
      <wxs module="styleHelper">
      var getStyleClass = function(tag) {
        // å®šä¹‰æ±‰å­—åˆ°è‹±æ–‡é£æ ¼çš„æ˜ å°„
        var map = {
          'ç‹ ': 'red', 'çˆ†': 'red', 'ç‡ƒ': 'red', 'è½': 'red',
          'å‡†': 'blue', 'å·§': 'blue', 'åŠ›': 'blue',
          'å…­': 'purple', 'æ··': 'purple', 'ç‰¢': 'purple',
          'å¯Œ': 'gold', 'æµª': 'gold',
          'å‡¡': 'silver', 'æ–°': 'silver'
        };
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œé»˜è®¤è¿”å› silver
        return map[tag] || 'silver';
      }
      module.exports.getStyleClass = getStyleClass;
      </wxs>
      <view class="profile-card">
        <view class="playtime-tag">
          <text class="label">æ¸¸æˆå†…æ—¶é•¿</text>
          <text class="value">{{ userData.timePlayed }}h</text>
        </view>

        <view class="style-badge style-{{styleHelper.getStyleClass(userData.style_tag)}}">
          <text class="style-label">STYLE</text>
          <view class="style-char-box">
            <text class="style-char">{{ userData.style_tag || 'å‡¡' }}</text>
          </view>
        </view>

        <view class="profile-info">
          <block wx:if="{{ canEdit }}">
            <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
              <image class="avatar" src="{{ userData.avatar }}" mode="aspectFill"></image>
              <view class="edit-hint">ğŸ“·</view>
            </button>
          </block>
          <image wx:else class="avatar" src="{{ userData.avatar }}" mode="aspectFill"></image>
          <view class="text-group">
            <block wx:if="{{ canEdit }}">
              <input type="nickname" class="nickname-input" placeholder="ç‚¹å‡»è®¾ç½®æ˜µç§°" value="{{ userData.nickname }}" bind:change="onNicknameChange" bindblur="onNicknameChange" />
            </block>
            <text wx:else class="nickname">{{ userData.nickname }}</text>
            <view class="level-badge">
              <text>ID: {{ userInfo.steam_id || '---' }}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="stats-grid">
        <view class="stat-box">
          <text class="stat-label">Avg K/D (30d)</text>
          <text class="stat-value {{ userData.kd >= 1.2 ? 'gold' : '' }}">{{ userData.kd }}</text>
        </view>
        <view class="stat-box">
          <text class="stat-label">â˜…StarTrackâ„¢ï¸</text>
          <text class="stat-value">{{ userData.totalKills }}</text>
        </view>
        <view class="stat-box">
          <text class="stat-label">ADR</text>
          <text class="stat-value">{{ userData.adr }}</text>
        </view>
        <view class="stat-box">
          <text class="stat-label">Win Rate</text>
          <text class="stat-value">{{ userData.winRate }}%</text>
        </view>
      </view>
      <view class="section-title">èƒ½åŠ›æ¨¡å‹ (Capability)</view>
      <view class="chart-container radar-container">
        <canvas type="2d" id="radarCanvas" class="radar-canvas"></canvas>
      </view>
      <view class="section-title">è¿‘æœŸçŠ¶æ€ (KD Trend)</view>
      <view class="chart-container">
        <canvas type="2d" id="trendCanvas" style="width: 100%; height: 100%;" bindtouchstart="onTouchChartStart" bindtouchmove="onTouchChartMove" bindtouchend="onTouchChartEnd"></canvas>
      </view>
      <view style="text-align: center; color: #666; font-size: 20rpx; margin-top: -20rpx; margin-bottom: 30rpx;">
        â† å·¦å³æ»‘åŠ¨æŸ¥çœ‹å†å² Â· ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’
      </view>
      <view class="section-title">æ¯æ—¥æˆ˜æŠ¥ (Daily Log)</view>
      <view class="match-list">
        <block wx:for="{{ matchHistory }}" wx:key="date">
          <view class="match-item">
            <view class="match-left">
              <view class="map-tag">{{ item.date }}</view>
              <text class="sub-label">{{ item.rounds }} Rnds</text>
            </view>
            <view class="match-center-main">
              <text class="score">{{ item.score }}</text>
              <view class="tag-row">
                <text class="kd-tag {{ item.Rating >= 1.0 ? 'pos' : 'neg' }}">{{ item.Rating }}</text>
              </view>
            </view>
            <view class="match-right-grid">
              <view class="grid-row">
                <text class="stat-mini">
                  ADR:
                  <text class="val">{{ item.adr }}</text>
                </text>
                <text class="stat-mini">
                  MVP:
                  <text class="val gold">{{ item.mvp }}</text>
                </text>
              </view>
              <view class="grid-row">
                <text class="stat-mini">
                  HS%:
                  <text class="val">{{ item.hsr }}%</text>
                </text>
                <text class="stat-mini">
                  DMG:
                  <text class="val">{{ item.dmg }}</text>
                </text>
              </view>
            </view>
          </view>
        </block>
        <view wx:if="{{matchHistory.length === 0}}" style="text-align:center; color:#666; padding:20rpx;">
          æš‚æ— æ¯”èµ›è®°å½•
        </view>
      </view>
    </scroll-view>
  </block>
</view>